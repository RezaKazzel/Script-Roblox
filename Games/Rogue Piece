-- ============ SERVICES ============
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ============ VARIABLES ============
local player = Players.LocalPlayer
local remote = ReplicatedStorage.Remotes.Serverside
local VIM = VirtualInputManager

-- ============ STATE MANAGEMENT ============
local State = {
	Connections = {},
	Threads = {},
	Toggles = {
		GodMode = false,
		FastAttack = false,
		AutoFishing = false,
		AutoBoss = false,
		AutoSpawnBoss = false,
		AutoFarmBossFish = false,
		AutoMuzan = false,
		AutoExchange = false
	},
	Boss = {
		Active = false,
		Connection = nil,
		LastName = ""
	}
}

-- ============ UI SETUP ============
local Exclusive = Rey:CreateTab(UI, "Exclusive+")
local Exclusive2 = Rey:CreateTab(UI, "Exclusive+ 2")

-- ============ UTILITY FUNCTIONS ============
local Utils = {}

function Utils.Disconnect(conn)
	if conn and typeof(conn) == "RBXScriptConnection" then
		conn:Disconnect()
		return true
	end
	return false
end

function Utils.Cleanup(key)
	if State.Connections[key] then
		Utils.Disconnect(State.Connections[key])
		State.Connections[key] = nil
	end
end

function Utils.AddConn(key, conn)
	Utils.Cleanup(key)
	State.Connections[key] = conn
	return conn
end

function Utils.StopThread(key)
	if State.Threads[key] then
		task.cancel(State.Threads[key])
		State.Threads[key] = nil
	end
end

function Utils.StartThread(key, func)
	Utils.StopThread(key)
	State.Threads[key] = task.spawn(func)
end

function Utils.FireRemote(...)
	local args = {...}
	pcall(function()
		remote:FireServer(unpack(args))
	end)
end

-- GANTI FUNGSI NOTIFY DENGAN YANG DARI REY LIBRARY
function Utils.Notify(type, title, message, duration)
	Rey:Notify(type, title, message, duration)
end

-- ============ HAKI SYSTEM ============
local Haki = {}

function Haki.Setup(character)
	if not character or character.Parent == nil then return end
	if character:FindFirstChild("Haki") then return end
	
	local conn
	conn = character.ChildAdded:Connect(function(child)
		if child.Name == "Haki" then
			if conn then
				conn:Disconnect()
				conn = nil
			end
		end
	end)
	
	remote:FireServer("Server", "Misc", "Haki", 1)
	
	task.delay(3, function()
		if conn then
			conn:Disconnect()
			conn = nil
		end
	end)
end

function Haki.Initialize()
	if player.Character then 
		Haki.Setup(player.Character) 
	end
	
	player.CharacterAdded:Connect(function(character)
		task.wait(1)
		Haki.Setup(character)
	end)
end

task.spawn(Haki.Initialize)

-- ============ BOSS SYSTEM ============
local Boss = {}

function Boss.Find()
	local mainFolder = workspace:FindFirstChild("Main")
	if not mainFolder then return nil end
	
	local charsFolder = mainFolder:FindFirstChild("Characters")
	if not charsFolder then return nil end
	
	for _, island in pairs(charsFolder:GetChildren()) do
		local bossFolder = island:FindFirstChild("Boss")
		if bossFolder then
			for _, bossModel in pairs(bossFolder:GetChildren()) do
				if bossModel:IsA("Model") then
					local hrp = bossModel:FindFirstChild("HumanoidRootPart")
					local hum = bossModel:FindFirstChild("Humanoid")
					
					if hrp and hum and hum.Health > 0 then
						return {
							Model = bossModel,
							HRP = hrp,
							Humanoid = hum,
							Island = island.Name,
							Name = bossModel.Name
						}
					end
				end
			end
		end
	end
	
	return nil
end

function Boss.Attack(bossData)
	if not bossData or not bossData.Model or not bossData.Model.Parent then 
		return false 
	end
	
	local char = player.Character
	if not char then return false end
	
	local tool = char:FindFirstChildWhichIsA("Tool")
	if not tool then return false end
	
	local toolType = tool.ToolTip
	if not toolType then return false end
	
	return pcall(function()
		remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
	end)
end

function Boss.RemoveVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and torso:FindFirstChild("BodyVelocity") then
		torso.BodyVelocity:Destroy()
	end
end

function Boss.Toggle(state)
	State.Boss.Active = state
	
	if State.Boss.Connection then
		State.Boss.Connection:Disconnect()
		State.Boss.Connection = nil
	end
	
	Boss.RemoveVelocity()
	
	if state then
		State.Boss.Connection = RunService.Heartbeat:Connect(function()
			if not player.Character then 
				Boss.RemoveVelocity()
				return 
			end
			
			local playerHRP = player.Character:FindFirstChild("HumanoidRootPart")
			if not playerHRP then 
				Boss.RemoveVelocity()
				return 
			end
			
			local boss = Boss.Find()
			
			if boss then
				if boss.Name ~= State.Boss.LastName then
					Utils.Notify("info", "Boss Detected", "Boss Spawned: " .. boss.Name, 5)
					State.Boss.LastName = boss.Name
				end
				
				local torso = player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("LowerTorso")
				if torso and not torso:FindFirstChild("BodyVelocity") then
					local bv = Instance.new("BodyVelocity", torso)
					bv.Velocity = Vector3.new(0, 0.1, 0)
					bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
				end
				
				if boss.Humanoid and boss.Humanoid.Health > 0 then
					local targetPos = boss.HRP.Position + Vector3.new(0, boss.HRP.Size.Y / 2 + 5, 0)
					playerHRP.CFrame = CFrame.new(targetPos, targetPos - Vector3.new(0, 1, 0))
					Boss.Attack(boss)
				end
			else
				Boss.RemoveVelocity()
				State.Boss.LastName = ""
			end
		end)
	end
end

player.CharacterAdded:Connect(function(char)
	task.wait(1)
	
	if State.Boss.Active then
		Boss.Toggle(false)
		Boss.Toggle(true)
	end
end)

-- ============ GOD MODE SYSTEM ============
local God = {}

function God.MuteObservation(char)
	if not char or char.Parent == nil then return false end
	
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	
	local obs = hrp:FindFirstChild("Observation")
	if obs then
		obs.Volume = 0
		return true
	end
	
	return false
end

function God.StartLoop()
	Utils.StartThread("godMode", function()
		while State.Toggles.GodMode do
			if player.Character and player.Character.Parent ~= nil then
				Utils.FireRemote("Server", "Misc", "Observation", 1)
			end
			task.wait(1)
		end
	end)
end

function God.SetupObservers()
	if player.Character then 
		God.MuteObservation(player.Character)
		
		local hrp = player.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			Utils.AddConn("obsChild", hrp.ChildAdded:Connect(function(child)
				if child.Name == "Observation" then
					child.Volume = 0
				elseif child.Name == "Dodge" then
					task.wait(0.1)
					if child.Parent then
						child:Destroy()
					end
				end
			end))
		end
		
		Utils.AddConn("dodgeRemover", player.Character.ChildAdded:Connect(function(child)
			if child.Name == "Dodge" then
				task.wait(0.1)
				if child.Parent then
					child:Destroy()
				end
			end
		end))
	end
	
	Utils.AddConn("charAddedGod", player.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		God.MuteObservation(char)
		
		local hrp = char:WaitForChild("HumanoidRootPart", 5)
		if hrp then
			Utils.AddConn("obsChild", hrp.ChildAdded:Connect(function(child)
				if child.Name == "Observation" then
					child.Volume = 0
				elseif child.Name == "Dodge" then
					task.wait(0.1)
					if child.Parent then
						child:Destroy()
					end
				end
			end))
		end
		
		Utils.AddConn("dodgeRemover", char.ChildAdded:Connect(function(child)
			if child.Name == "Dodge" then
				task.wait(0.1)
				if child.Parent then
					child:Destroy()
				end
			end
		end))
	end))
end

function God.Toggle(state)
	State.Toggles.GodMode = state
	
	if state then
		God.SetupObservers()
		God.StartLoop()
	else
		Utils.Cleanup("charAddedGod")
		Utils.Cleanup("obsChild")
		Utils.Cleanup("dodgeRemover")
		Utils.StopThread("godMode")
	end
end

-- ============ FAST ATTACK SYSTEM ============
local Fast = {}

function Fast.GetCharacter()
	local main = workspace:FindFirstChild("Main")
	if not main then return nil end
	
	local chars = main:FindFirstChild("Characters")
	if not chars then return nil end
	
	return chars:FindFirstChild(player.Name)
end

function Fast.GetEquippedTool()
	local char = Fast.GetCharacter()
	if not char then return nil, nil end
	
	local tool = char:FindFirstChildWhichIsA("Tool")
	if not tool then return nil, nil end
	
	return tool, tool.ToolTip
end

function Fast.StartLoop()
	Utils.StartThread("fastAttack", function()
		while State.Toggles.FastAttack do
			local char = Fast.GetCharacter()
			if char and char.Parent ~= nil then
				local tool, toolType = Fast.GetEquippedTool()
				if tool and toolType then
					Utils.FireRemote("Server", toolType, "M1s", tool.Name, 1)
				end
			end
			task.wait()
		end
	end)
end

function Fast.Toggle(state)
	State.Toggles.FastAttack = state
	
	if state then
		Fast.StartLoop()
	else
		Utils.StopThread("fastAttack")
	end
end

-- ============ FISHING SYSTEM ============
local Fish = {}

function Fish.Setup()
	Utils.Cleanup("autoFishing")
	Utils.StopThread("autoFishing")
	
	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end
	
	local HUD = playerGui:WaitForChild("HUD", 10)
	if not HUD then return end
	
	Utils.StartThread("autoFishing", function()
		while State.Toggles.AutoFishing do
			task.wait()
			
			local fishing = HUD:FindFirstChild("Fishing")
			if fishing then
				local button = fishing:FindFirstChild("Button")
				if button then
					GuiService.SelectedObject = button
					VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
					VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
					task.wait()
					GuiService.SelectedObject = nil
				end
			end
		end
	end)
end

function Fish.Toggle(state)
	State.Toggles.AutoFishing = state
	
	if state then
		Fish.Setup()
		Utils.Cleanup("playerCharAdded")
		State.Connections["playerCharAdded"] = player.CharacterAdded:Connect(function()
			task.wait(1)
			if State.Toggles.AutoFishing then
				Fish.Setup()
			end
		end)
	else
		Utils.Cleanup("autoFishing")
		Utils.StopThread("autoFishing")
		Utils.Cleanup("playerCharAdded")
		GuiService.SelectedObject = nil
	end
end

-- ============ BOSS LIST ============
local function getBossList()
	local list = {}
	local bossUI = player.PlayerGui.Button["Boss Spawn"]
	
	if bossUI then
		local frame = bossUI:FindFirstChild("Frame")
		if frame then
			for _, child in pairs(frame:GetChildren()) do
				if child:IsA("Frame") and child.Name ~= "Frame" then
					local button = child:FindFirstChild("Button")
					if button then
						table.insert(list, child.Name)
					end
				end
			end
		end
	end
	
	return list
end

local bossOptions = getBossList()
local selectedBoss = nil

-- ============ TOOL MANAGER ============
local selectedTools = {}

local function GetTools()
	local tools = {}
	local backpack = player:FindFirstChild("Backpack")
	
	if backpack then
		for _, item in pairs(backpack:GetChildren()) do
			if item:IsA("Tool") then
				table.insert(tools, item.Name)
			end
		end
	end
	
	return tools
end

local function EquipSelectedTools()
	if not player.Character then return end
	
	local backpack = player:FindFirstChild("Backpack")
	if not backpack then return end
	
	for toolName, _ in pairs(selectedTools) do
		local tool = backpack:FindFirstChild(toolName)
		if tool then
			tool.Parent = player.Character
			tool:Activate()
		end
	end
end

-- ============ AUTO FARM BOSS + FISHING (WITH TOOL SUPPORT) ============
local AutoFarmBossFish = {}

function AutoFarmBossFish.CheckFishing()
	local fishing = player:FindFirstChild("Fishing")
	if not fishing then
		remote:FireServer("Server", "Misc", "Fishing", true)
	end
	return true
end

function AutoFarmBossFish.CancelFishing()
	local fishing = player:FindFirstChild("Fishing")
	if fishing then
		remote:FireServer("Server", "Misc", "Fishing", false)
	end
end

function AutoFarmBossFish.FindBoss()
	local mainFolder = workspace:FindFirstChild("Main")
	if not mainFolder then return nil end
	
	local charsFolder = mainFolder:FindFirstChild("Characters")
	if not charsFolder then return nil end
	
	for _, island in pairs(charsFolder:GetChildren()) do
		local bossFolder = island:FindFirstChild("Boss")
		if bossFolder then
			for _, bossModel in pairs(bossFolder:GetChildren()) do
				if bossModel:IsA("Model") then
					local hrp = bossModel:FindFirstChild("HumanoidRootPart")
					local hum = bossModel:FindFirstChild("Humanoid")
					
					if hrp and hum and hum.Health > 0 then
						return {
							Model = bossModel,
							HRP = hrp,
							Humanoid = hum,
							Island = island.Name,
							Name = bossModel.Name
						}
					end
				end
			end
		end
	end
	
	return nil
end

function AutoFarmBossFish.GetEquippedTool()
	local char = player.Character
	if not char then return nil, nil end
	
	-- Cari tool yang di-equip dari selectedTools
	for toolName, _ in pairs(selectedTools) do
		local tool = char:FindFirstChild(toolName)
		if tool then
			return tool, tool.ToolTip
		end
	end
	
	-- Jika tidak ada tool yang dipilih, gunakan tool pertama yang ada
	local anyTool = char:FindFirstChildWhichIsA("Tool")
	if anyTool then
		return anyTool, anyTool.ToolTip
	end
	
	return nil, nil
end

function AutoFarmBossFish.AttackBoss(bossData)
	if not bossData then return false end
	
	local tool, toolType = AutoFarmBossFish.GetEquippedTool()
	if not tool or not toolType then 
		EquipSelectedTools()
		tool, toolType = AutoFarmBossFish.GetEquippedTool()
		if not tool then return false end
	end
	
	return pcall(function()
		remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
	end)
end

function AutoFarmBossFish.SetupBodyVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and not torso:FindFirstChild("BodyVelocity") then
		local bv = Instance.new("BodyVelocity", torso)
		bv.Velocity = Vector3.new(0, 0.1, 0)
		bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	end
end

function AutoFarmBossFish.RemoveBodyVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and torso:FindFirstChild("BodyVelocity") then
		torso.BodyVelocity:Destroy()
	end
end

function AutoFarmBossFish.TeleportToBoss(bossData)
	if not bossData or not player.Character then return end
	
	local playerHRP = player.Character:FindFirstChild("HumanoidRootPart")
	if not playerHRP then return end
	
	local targetPos = bossData.HRP.Position + Vector3.new(0, bossData.HRP.Size.Y / 2 + 5, 0)
	playerHRP.CFrame = CFrame.new(targetPos, targetPos - Vector3.new(0, 1, 0))
end

function AutoFarmBossFish.StartFishing()
	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end
	
	local HUD = playerGui:WaitForChild("HUD", 10)
	if not HUD then return end
	
	local fishing = HUD:FindFirstChild("Fishing")
	if fishing then
		local button = fishing:FindFirstChild("Button")
		if button then
			GuiService.SelectedObject = button
			VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
			VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
			task.wait()
			GuiService.SelectedObject = nil
		end
	end
end

function AutoFarmBossFish.StartLoop()
	Utils.StartThread("autoFarmBossFish", function()
		local lastState = "fishing"
		
		while State.Toggles.AutoFarmBossFish do
			local boss = AutoFarmBossFish.FindBoss()
			
			if boss then
				if lastState ~= "boss" then
					AutoFarmBossFish.CancelFishing()
					lastState = "boss"
					EquipSelectedTools()
				end
				
				AutoFarmBossFish.SetupBodyVelocity()
				AutoFarmBossFish.TeleportToBoss(boss)
				AutoFarmBossFish.AttackBoss(boss)
			else
				if lastState ~= "fishing" then
					AutoFarmBossFish.RemoveBodyVelocity()
					lastState = "fishing"
				end
				
				if AutoFarmBossFish.CheckFishing() then
					AutoFarmBossFish.StartFishing()
				end
			end
			
			task.wait()
		end
		
		AutoFarmBossFish.RemoveBodyVelocity()
		AutoFarmBossFish.CancelFishing()
	end)
end

function AutoFarmBossFish.Toggle(state)
	State.Toggles.AutoFarmBossFish = state
	
	if state then
		EquipSelectedTools()
		AutoFarmBossFish.StartLoop()
		
		Utils.Cleanup("autoFarmCharAdded")
		State.Connections["autoFarmCharAdded"] = player.CharacterAdded:Connect(function()
			task.wait(1)
			if State.Toggles.AutoFarmBossFish then
				AutoFarmBossFish.Toggle(false)
				AutoFarmBossFish.Toggle(true)
			end
		end)
	else
		Utils.StopThread("autoFarmBossFish")
		AutoFarmBossFish.RemoveBodyVelocity()
		AutoFarmBossFish.CancelFishing()
		Utils.Cleanup("autoFarmCharAdded")
	end
end

-- ============ MUZAN BLOOD SYSTEM ============
local Muzan = {}

function Muzan.Buy()
	local inventory = player.Inventory
	local bossToken = inventory:FindFirstChild("Boss Token")
	
	if bossToken and bossToken.Value > 750 then
		local shop = player.PlayerGui.Button["Shop Item"]
		if not shop then return false end
		
		shop.Visible = true
		local tokenFrame = shop:FindFirstChild("Token")
		if not tokenFrame then 
			shop.Visible = false
			return false 
		end
		
		local muzanItem = tokenFrame:FindFirstChild("Muzan's Blood")
		if not muzanItem then 
			shop.Visible = false
			return false 
		end
		
		local buyFrame = muzanItem:FindFirstChild("Buy")
		if not buyFrame then 
			shop.Visible = false
			return false 
		end
		
		local button = buyFrame:FindFirstChild("Button")
		if not button then 
			shop.Visible = false
			return false 
		end
		
		GuiService.SelectedObject = button
		VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
		VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
		task.wait(0.5)
		GuiService.SelectedObject = nil
		shop.Visible = false
		return true
	end
	return false
end

function Muzan.StartLoop()
	Utils.StartThread("muzan", function()
		while State.Toggles.AutoMuzan do
			Muzan.Buy()
			task.wait(5)
		end
	end)
end

function Muzan.Toggle(state)
	State.Toggles.AutoMuzan = state
	
	if state then
		Muzan.StartLoop()
	else
		Utils.StopThread("muzan")
	end
end

-- ============ AUTO EXCHANGE SYSTEM ============
local Exchange = {}

Exchange.EXCEPTIONS = {
	["Summon Orb"] = true,
	["RC Cells"] = true
}

function Exchange.GetAmount(text)
	local clean = text:gsub("%[x", ""):gsub("%]", "")
	return tonumber(clean) or 0
end

function Exchange.CheckAndSell()
	local exchange = player.PlayerGui.Button["Chest Exchange"]
	if not exchange then return end
	
	local medalFrame = exchange:FindFirstChild("Medal_Frame")
	if not medalFrame then return end
	
	for _, child in pairs(medalFrame:GetChildren()) do
		if child:IsA("Frame") then
			local name = child.Name
			if Exchange.EXCEPTIONS[name] then
				continue
			end
			
			local amountChild = child:FindFirstChild("Amount") or child:FindFirstChild("Amout")
			local button = child:FindFirstChild("Button")
			
			if amountChild and button then
				local amount = Exchange.GetAmount(amountChild.Text)
				
				if amount > 250 then
					exchange.Visible = true
					GuiService.SelectedObject = button
					VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
					VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
					task.wait(0.2)
					GuiService.SelectedObject = nil
					exchange.Visible = false
				end
			end
		end
	end
end

function Exchange.StartLoop()
	Utils.StartThread("exchange", function()
		while State.Toggles.AutoExchange do
			Exchange.CheckAndSell()
			task.wait(10)
		end
	end)
end

function Exchange.Toggle(state)
	State.Toggles.AutoExchange = state
	
	if state then
		Exchange.StartLoop()
	else
		Utils.StopThread("exchange")
	end
end

-- ============ AUTO SPAWN BOSS SYSTEM ============
local AutoSpawn = {}

function AutoSpawn.Toggle(state)
	if state then
		local bossSpawn = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"]
		if bossSpawn then
			bossSpawn.BackgroundTransparency = 1
			local spawnFrame = bossSpawn.Spawn
			if spawnFrame then
				local button = spawnFrame.Button
				if button then
					for _, descendant in ipairs(bossSpawn:GetDescendants()) do
						if descendant:IsA("GuiObject") then
							if descendant == button or descendant == spawnFrame or descendant == bossSpawn then
								descendant.Visible = true
								if descendant:IsA("Frame") then
									descendant.BackgroundTransparency = 1
								end
							else
								descendant.Visible = false
							end
						end
					end
					button.Visible = true
					spawnFrame.Visible = true
					bossSpawn.Visible = true
				end
			end
		end
		
		task.spawn(function()
			while AutoSpawn.Running do task.wait(0.8)
				pcall(function()
					local inventory = game:GetService("Players").LocalPlayer.Inventory
					local summonOrb = inventory:FindFirstChild("Summon Orb")
					
					if summonOrb then
						if State.Toggles.AutoFarmBossFish and summonOrb.Value < 750 then
							return
						end
					end
					
					local obj = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"].Spawn.Button
					GuiService.SelectedObject = obj
					VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
					VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
					task.wait()
					GuiService.SelectedObject = nil
				end)
			end
		end)
	else
		AutoSpawn.Running = false
		
		local bossSpawn = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"]
		if bossSpawn then
			bossSpawn.BackgroundTransparency = 0
			for _, descendant in ipairs(bossSpawn:GetDescendants()) do
				if descendant:IsA("GuiObject") then
					descendant.Visible = true
					if descendant:IsA("Frame") then
						descendant.BackgroundTransparency = 0
					end
				end
			end
			bossSpawn.Visible = false
		end
	end
end
-- ============ UI COMPONENTS ============
Rey:CreateMultipleDropdown(Exclusive, "Pilih Tools", GetTools, function(selectedList)
	selectedTools = {}
	for _, toolName in pairs(selectedList) do
		selectedTools[toolName] = true
	end
end, true)

Rey:CreateToggle(Exclusive, "Auto Boss + Fishing", "Auto farm boss dan fishing", AutoFarmBossFish.Toggle)

Rey:CreateToggle(Exclusive, "Auto Bosses", "Auto farm bosses (bug)", function(state)
	Boss.Toggle(state)
end)

Rey:CreateToggle(Exclusive, "God Mode", "Butuh: Observation Haki", God.Toggle)

Rey:CreateToggle(Exclusive, "Fast Attack M1", "Butuh: Tool yang di-equip", Fast.Toggle)

Rey:CreateToggle(Exclusive, "Auto Fishing", "Auto fishing system baru", Fish.Toggle)

Rey:CreateButton(Exclusive, "Start Fishing", "Mancing dimanapun", "Start", function()
	local fishing = player:FindFirstChild("Fishing")
	if not fishing then
		remote:FireServer("Server", "Misc", "Fishing", true)
	end
end)

Rey:CreateDropdown(Exclusive, "Pilih Boss", bossOptions, function(boss)
	selectedBoss = boss
	
	local bossUI = player.PlayerGui.Button["Boss Spawn"]
	if bossUI then
		bossUI.Visible = true
		local frame = bossUI:FindFirstChild("Frame")
		if frame and selectedBoss then
			local bossFrame = frame:FindFirstChild(selectedBoss)
			if bossFrame then
				local button = bossFrame:FindFirstChild("Button")
				if button then
					GuiService.SelectedObject = button
					VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
					VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
					task.wait()
					GuiService.SelectedObject = nil
					bossUI.Visible = false
				end
			end
		end
	end
end, false)

Rey:CreateToggle(Exclusive, "Auto Spawn Boss", "Select Boss nya dulu", function(state)
	AutoSpawn.Running = state
	AutoSpawn.Toggle(state)
end)

Rey:CreateNote(Exclusive, "-\n-\n-\n-\n-")

-- ============ EXCLUSIVE 2 ============
Rey:CreateToggle(Exclusive2, "Disable Announced Pop-up", "-", function(state)
	game:GetService("Players").LocalPlayer.Setting["Announce Pop-up"].Value = not state
end)
Rey:CreateToggle(Exclusive2, "Auto Exchange Chest", "Auto exchange chest jika >250", Exchange.Toggle)
Rey:CreateToggle(Exclusive2, "Auto Buy Muzan Blood", "Auto buy jika Boss Token > 750", Muzan.Toggle)

Rey:CreateNote(Exclusive2, "⚠️ Warning: Don't activate features unnecessarily to avoid lag")
Rey:CreateButton(Exclusive2, "Farm Level Busoshoku Haki", "Level up gradually to avoid lag", "Level Up", function()
	for i = 1, 500 do
		if player.Character and player.Character.Parent ~= nil then
			Utils.FireRemote("Server", "Misc", "Haki", 1)
			Utils.FireRemote("Server", "Misc", "Haki", 2)
		else
			break
		end
	end
end)

Rey:CreateNote(Exclusive2, "⚠️ Warning: Semua Skill bakal di deactivate paksa\nBisa Fix Yuta Lag Issue, respawn klo mau matiin fitur")
Rey:CreateButton(Exclusive2, "Disable Mobile Check Skill", "Baca note diatas", "DISABLE", function()
	local mobileUI = player.PlayerGui:FindFirstChild("Mobile")
	if mobileUI then
		local check = mobileUI:FindFirstChild("Check")
		if check then
			check.Disabled = true
		end
	end
end)

local forceMenuActive = false
local selectedMenu = nil
local prevMenu = nil

local function getMenuOptions()
	local options = {}
	local playerGui = player.PlayerGui
	
	if playerGui and playerGui.Button then
		for _, child in pairs(playerGui.Button:GetChildren()) do
			if child:IsA("Frame") then
				local name = child.Name
				name = name:gsub("_Frame", "")
				table.insert(options, name)
			end
		end
	end
	
	return options
end

local function getOriginalName(displayName)
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return displayName end
	
	local frame = playerGui.Button:FindFirstChild(displayName)
	if frame then return displayName end
	
	frame = playerGui.Button:FindFirstChild(displayName .. "_Frame")
	if frame then return displayName .. "_Frame" end
	
	return displayName
end

local function hideAllMenus()
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return end
	
	for _, child in pairs(playerGui.Button:GetChildren()) do
		if child:IsA("Frame") then
			child.Visible = false
		end
	end
end

local function showSelectedMenu()
	if not forceMenuActive or not selectedMenu then return end
	
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return end
	
	local originalName = getOriginalName(selectedMenu)
	local menuFrame = playerGui.Button:FindFirstChild(originalName)
	if menuFrame then
		menuFrame.Visible = true
	end
end

local function toggleForceMenu(state)
	forceMenuActive = state
	
	if state then
		if selectedMenu then
			showSelectedMenu()
		end
	else
		hideAllMenus()
		prevMenu = nil
	end
end

local menuOptions = getMenuOptions()
Rey:CreateDropdown(Exclusive2, "Select Menu", menuOptions, function(selection)
	if prevMenu then
		local originalPrev = getOriginalName(prevMenu)
		local prevFrame = player.PlayerGui.Button:FindFirstChild(originalPrev)
		if prevFrame then
			prevFrame.Visible = false
		end
	end
	
	selectedMenu = selection
	prevMenu = selection
	
	if forceMenuActive then
		showSelectedMenu()
	end
end, true)

Rey:CreateToggle(Exclusive2, "Force Menu", "Force open selected menu", toggleForceMenu)
Rey:CreateNote(Exclusive2, "-\n-\n-\n-\n-")

-- ============ CLEANUP ============
local Cleanup = {}

function Cleanup.All()
	for key, conn in pairs(State.Connections) do
		Utils.Disconnect(conn)
	end
	table.clear(State.Connections)
	
	for key, thread in pairs(State.Threads) do
		if thread then
			task.cancel(thread)
		end
	end
	table.clear(State.Threads)
	
	for key, _ in pairs(State.Toggles) do
		State.Toggles[key] = false
	end
	
	State.Boss.Active = false
	State.Boss.LastName = ""
	if State.Boss.Connection then
		State.Boss.Connection:Disconnect()
		State.Boss.Connection = nil
	end
	
	Boss.RemoveVelocity()
	AutoFarmBossFish.RemoveBodyVelocity()
	AutoFarmBossFish.CancelFishing()
	AutoSpawn.RestoreUI()
	GuiService.SelectedObject = nil
end

local removeConn
removeConn = Players.PlayerRemoving:Connect(function(leavingPlayer)
	if leavingPlayer == player then
		Utils.Disconnect(removeConn)
		Cleanup.All()
	end
end)

player.CharacterAdded:Connect(function()
	if State.Toggles.GodMode then
		God.SetupObservers()
	end
	
	if State.Boss.Active then
		Boss.Toggle(false)
		Boss.Toggle(true)
	end
end)

game:GetService("CoreGui").DescendantRemoving:Connect(function(desc)
	if desc == UI then
		Cleanup.All()
	end
end)

-- ============ FINAL ============
Utils.Notify("success", "Rogue Piece", "Script Loaded Successfully!", 5)
