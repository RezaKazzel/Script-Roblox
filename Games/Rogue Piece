local Rey = loadstring(game:HttpGet("https://raw.githubusercontent.com/RezaKazzel/Script-Roblox/refs/heads/main/UI/Rey%20Library%20New"))()
local Exclusive = Rey:CreateTab(UI, "Exclusive+")

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local remote = ReplicatedStorage.Remotes.Serverside

local activeConnections = {}
local activeThreads = {}
local toggleStates = {
	godMode = false,
	fastAttack = false,
	fixFishing = false
}

-- ============ HELPER FUNCTIONS ============
local function safeDisconnect(connection)
	if connection and typeof(connection) == "RBXScriptConnection" then
		connection:Disconnect()
		return true
	end
	return false
end

local function cleanupConnection(key)
	if activeConnections[key] then
		safeDisconnect(activeConnections[key])
		activeConnections[key] = nil
	end
end

local function stopThread(key)
	if activeThreads[key] then
		task.cancel(activeThreads[key])
		activeThreads[key] = nil
	end
end

local function startThread(key, func)
	stopThread(key)
	activeThreads[key] = task.spawn(func)
end

-- ============ AUTO HAKI SETUP ============
task.spawn(function()
	local function setupHaki(character)
		if not character or character.Parent == nil then return end
		
		if character:FindFirstChild("Haki") then return end
		
		local hakiConnection
		hakiConnection = character.ChildAdded:Connect(function(child)
			if child.Name == "Haki" then
				safeDisconnect(hakiConnection)
			end
		end)
		
		pcall(function()
			remote:FireServer("Server", "Misc", "Haki", 1)
		end)
	end
	
	if player.Character then 
		setupHaki(player.Character) 
	end
	
	local charAddedConn
	charAddedConn = player.CharacterAdded:Connect(function(character)
		task.wait(0.5)
		setupHaki(character)
	end)
	game:GetService("Players").PlayerRemoving:Connect(function(leavingPlayer)
		if leavingPlayer == player then
			safeDisconnect(charAddedConn)
		end
	end)
end)

-- ============ AUTO BOSSES ============

local autoBossActive = false
local autoBossConnection = nil
local lastBossName = ""

local function findBossFolder()
    local mainFolder = workspace:FindFirstChild("Main")
    if not mainFolder then return nil end
    
    local charactersFolder = mainFolder:FindFirstChild("Characters")
    if not charactersFolder then return nil end
    
    for _, islandFolder in pairs(charactersFolder:GetChildren()) do
        local bossFolder = islandFolder:FindFirstChild("Boss")
        if bossFolder then
            for _, bossModel in pairs(bossFolder:GetChildren()) do
                if bossModel:IsA("Model") then
                    local humanoidRootPart = bossModel:FindFirstChild("HumanoidRootPart")
                    local humanoid = bossModel:FindFirstChild("Humanoid")
                    
                    if humanoidRootPart and humanoid and humanoid.Health > 0 then
                        return {
                            Model = bossModel,
                            HRP = humanoidRootPart,
                            Humanoid = humanoid,
                            Island = islandFolder.Name,
                            Name = bossModel.Name
                        }
                    end
                end
            end
        end
    end
    
    return nil
end

local function attackBoss(boss)
    if not boss or not boss.Model or not boss.Model.Parent then return false end
    
    local character = player.Character
    if not character then return false end
    
    local tool = character:FindFirstChildWhichIsA("Tool")
    if not tool then return false end
    
    local toolType = tool.ToolTip
    if not toolType then return false end
    
    local success = pcall(function()
        remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
    end)
    
    return success
end

local function removeBodyVelocity()
    local torso = player.Character and (player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("LowerTorso"))
    if torso and torso:FindFirstChild("BodyVelocity") then
        torso.BodyVelocity:Destroy()
    end
end

local function toggleAutoBosses(state)
    autoBossActive = state
    
    if autoBossConnection then
        autoBossConnection:Disconnect()
        autoBossConnection = nil
    end
    
    removeBodyVelocity()
    
    if state then
        autoBossConnection = RunService.Heartbeat:Connect(function()
            if not player.Character then 
                removeBodyVelocity()
                return 
            end
            
            local playerHRP = player.Character:FindFirstChild("HumanoidRootPart")
            if not playerHRP then 
                removeBodyVelocity()
                return 
            end
            
            local boss = findBossFolder()
            
            if boss then
                if boss.Name ~= lastBossName then
                    Notif("info", "Boss Detected", "Boss just Spawned: "..boss.Name, 5)
                    lastBossName = boss.Name
                end
                
                local torso = player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("LowerTorso")
                if torso and not torso:FindFirstChild("BodyVelocity") then
                    local bv = Instance.new("BodyVelocity", torso)
                    bv.Velocity = Vector3.new(0, 0.1, 0)
                    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                end
                
                if boss.Humanoid and boss.Humanoid.Health > 0 then
                    local targetPosition = boss.HRP.Position + Vector3.new(0, boss.HRP.Size.Y / 2 + 5, 0)
                    playerHRP.CFrame = CFrame.new(targetPosition, targetPosition - Vector3.new(0, 1, 0))
                    attackBoss(boss)
                end
            else
                removeBodyVelocity()
                lastBossName = ""
            end
        end)
    end
end

Rey:CreateToggle(Exclusive, "Auto Bosses", "Auto Farm Bosses ( Bug )", toggleAutoBosses)

player.CharacterAdded:Connect(function(character)
    task.wait(1)
    
    if autoBossActive then
        toggleAutoBosses(false)
        toggleAutoBosses(true)
    end
end)

-- ============ GOD MODE (OBSERVATION) ============
local function muteObservation(character)
	if not character or character.Parent == nil then return end
	
	local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
	if not humanoidRootPart then return end
	
	local observation = humanoidRootPart:FindFirstChild("Observation")
	if observation then
		observation.Volume = 0
		return true
	end
	
	return false
end

local function startGodModeLoop()
	startThread("godMode", function()
		while toggleStates.godMode do
			if player.Character and player.Character.Parent ~= nil then
				pcall(function()
					remote:FireServer("Server", "Misc", "Observation", 1)
				end)
			end
			task.wait()
		end
	end)
end

local function setupCharacterObservers()
	if player.Character then 
		muteObservation(player.Character)
		local hrp = player.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			cleanupConnection("observationChildAdded")
			activeConnections["observationChildAdded"] = hrp.ChildAdded:Connect(function(child)
				if child.Name == "Observation" then
					child.Volume = 0
				end
			end)
		end
	end
	
	-- Setup untuk karakter baru (respawn)
	cleanupConnection("characterAddedGodMode")
	activeConnections["characterAddedGodMode"] = player.CharacterAdded:Connect(function(character)
		task.wait(0.5)
		muteObservation(character)
		local hrp = character:WaitForChild("HumanoidRootPart", 5)
		if hrp then
			cleanupConnection("observationChildAdded")
			activeConnections["observationChildAdded"] = hrp.ChildAdded:Connect(function(child)
				if child.Name == "Observation" then
					child.Volume = 0
				end
			end)
		end
	end)
end

local function toggleGodMode(state)
	toggleStates.godMode = state
	
	if state then
		setupCharacterObservers()
		startGodModeLoop()
	else
		cleanupConnection("characterAddedGodMode")
		cleanupConnection("observationChildAdded")
		stopThread("godMode")
	end
end

Rey:CreateToggle(Exclusive, "God Mode", "Requires: Observation Haki", toggleGodMode)

-- ============ FAST ATTACK M1 ============
local function getCharacter()
	local charactersFolder = workspace:FindFirstChild("Main")
	if not charactersFolder then return nil end
	
	charactersFolder = charactersFolder:FindFirstChild("Characters")
	if not charactersFolder then return nil end
	
	return charactersFolder:FindFirstChild(player.Name)
end

local function getEquippedTool()
	local character = getCharacter()
	if not character then return nil, nil end
	
	local tool = character:FindFirstChildWhichIsA("Tool")
	if not tool then return nil, nil end
	
	return tool, tool.ToolTip
end

local function startFastAttackLoop()
	startThread("fastAttack", function()
		while toggleStates.fastAttack do
			local character = getCharacter()
			if character and character.Parent ~= nil then
				local tool, toolType = getEquippedTool()
				if tool and toolType then
					pcall(function()
						remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
					end)
				end
			end
			task.wait()
		end
	end)
end

local function toggleFastAttack(state)
	toggleStates.fastAttack = state
	
	if state then
		startFastAttackLoop()
	else
		stopThread("fastAttack")
	end
end

Rey:CreateToggle(Exclusive, "Fast Attack M1", "Requires: Equipped Tool", toggleFastAttack)

-- ============ FIX FISHING POSITION ============
local function setFishingPosition(fishingFrame)
	if fishingFrame and fishingFrame.Parent ~= nil then
		fishingFrame.Position = UDim2.new(0.3, 0, 0, -30)
	end
end

local function setupFishingFix()
	cleanupConnection("fixFishing")
	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end
	local HUD = playerGui:WaitForChild("HUD", 10)
	if not HUD then return end
	local existingFishing = HUD:FindFirstChild("Fishing")
	if existingFishing then
		setFishingPosition(existingFishing)
	end
	activeConnections["fixFishing"] = HUD.ChildAdded:Connect(function(child)
		if child.Name == "Fishing" then
			setFishingPosition(child)
		end
	end)
end

local function toggleFixFishingPosition(state)
	toggleStates.fixFishing = state
	
	if state then
		setupFishingFix()
		cleanupConnection("playerGuiAdded")
		activeConnections["playerGuiAdded"] = player.CharacterAdded:Connect(function()
			if toggleStates.fixFishing then
				setupFishingFix()
			end
		end)
	else
		cleanupConnection("fixFishing")
		cleanupConnection("playerGuiAdded")
	end
end

Rey:CreateToggle(Exclusive, "Fix Fishing Position", "mancing rek", toggleFixFishingPosition)

-- ============ OTHER FEATURES ============
Rey:CreateNote(Exclusive, "⚠️ Warning: Don't activate features unnecessarily to avoid lag")

Rey:CreateButton(Exclusive, "Farm Level Busoshoku Haki", "Level up gradually to avoid lag", "Level Up", function()
	for i = 1, 500 do
		if player.Character and player.Character.Parent ~= nil then
			pcall(function()
				remote:FireServer("Server", "Misc", "Haki", 1)
				remote:FireServer("Server", "Misc", "Haki", 2)
			end)
		else
			break
		end
	end
end)

-- ============ CLEANUP SYSTEM ============
local function cleanupAll()
	for key, connection in pairs(activeConnections) do
		safeDisconnect(connection)
	end
	table.clear(activeConnections)
	
	for key, thread in pairs(activeThreads) do
		if thread then
			task.cancel(thread)
		end
	end
	table.clear(activeThreads)
	
	for key, _ in pairs(toggleStates) do
		toggleStates[key] = false
	end
end

local playerRemovingConn
playerRemovingConn = Players.PlayerRemoving:Connect(function(leavingPlayer)
	if leavingPlayer == player then
		safeDisconnect(playerRemovingConn)
		cleanupAll()
	end
end)

player.CharacterAdded:Connect(function()
	if toggleStates.godMode then
		setupCharacterObservers()
	end
	
	if toggleStates.fixFishing then
		setupFishingFix()
	end
end)

game:GetService("CoreGui").DescendantRemoving:Connect(function(descendant)
	if descendant == UI then
		cleanupAll()
	end
end)
