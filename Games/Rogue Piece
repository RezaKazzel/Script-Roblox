Rey = Rey or loadstring(game:HttpGet("https://raw.githubusercontent.com/RezaKazzel/Script-Roblox/refs/heads/main/UI/Rey%20Library%20Rework.lua"))()
-- ============ SERVICES ============
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualUser = game:GetService("VirtualUser")
-- ============ VARIABLES ============
local player = Players.LocalPlayer
local remote = ReplicatedStorage.Remotes.Serverside
local VIM = VirtualInputManager
local VU = VirtualUser
-- ============ STATE MANAGEMENT ============
local State = {
	Connections = {},
	Threads = {},
	Toggles = {
		GodMode = false,
		FastAttack = false,
		AutoFishing = false,
		AutoBoss = false,
		AutoSpawnBoss = false,
		AutoFarmBossFish = false,
		AutoKanekiBlood = false,
		AutoExchange = false
	},
	Boss = {
		Active = false,
		Connection = nil,
		LastName = ""
	}
}

-- ============ UI SETUP ============
UI = UI or Rey:CreateUI("Rogue Piece")
local Exclusive = Rey:CreateTab(UI, "Exclusive+")
local Exclusive2 = Rey:CreateTab(UI, "Exclusive+ 2")
Rey:EnableChatCommands()
-- ============ UTILITY FUNCTIONS ============
local Utils = {}

function Utils.Disconnect(conn)
	if conn and typeof(conn) == "RBXScriptConnection" then
		conn:Disconnect()
		return true
	end
	return false
end

function Utils.Cleanup(key)
	if State.Connections[key] then
		Utils.Disconnect(State.Connections[key])
		State.Connections[key] = nil
	end
end

function Utils.AddConn(key, conn)
	Utils.Cleanup(key)
	State.Connections[key] = conn
	return conn
end

function Utils.StopThread(key)
	if State.Threads[key] then
		task.cancel(State.Threads[key])
		State.Threads[key] = nil
	end
end

function Utils.StartThread(key, func)
	Utils.StopThread(key)
	State.Threads[key] = task.spawn(func)
end

function Utils.FireRemote(...)
	local args = {...}
	pcall(function()
		remote:FireServer(unpack(args))
	end)
end

Utils.PriorityQueue = {}
Utils.PriorityRunning = false
Utils.WaitingForPriority = false
function Utils.ProcessPriority()
	if Utils.PriorityRunning or #Utils.PriorityQueue == 0 then return end
	
	Utils.PriorityRunning = true
	Utils.WaitingForPriority = true
	
	task.spawn(function()
		while #Utils.PriorityQueue > 0 do
			local job = table.remove(Utils.PriorityQueue, 1)
			pcall(job)
		end
		
		Utils.PriorityRunning = false
		Utils.WaitingForPriority = false
	end)
end

function Utils.Priority(job)
	table.insert(Utils.PriorityQueue, job)
	if not Utils.PriorityRunning then
		Utils.ProcessPriority()
	end
end

function Utils.WaitPriority()
	while Utils.WaitingForPriority do
		task.wait()
	end
end

function Utils.CheckPriority()
	if Utils.WaitingForPriority then
		Utils.WaitPriority()
	end
end

function Utils.GuiClick(button)
	local x = pcall(function()
		GuiService.SelectedObject = button
		task.wait()
		if GuiService.SelectedObject.Parent == button.Parent then
			VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
			VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
		end
	end)
	task.wait()
	GuiService.SelectedObject = nil
	return x
end

function Utils.GuiMultiClick(button, clicks)
	clicks = tonumber(clicks) or 1
	if clicks > 0 then
		local x = pcall(function()
			GuiService.SelectedObject = button
			task.wait()
			for i=1,clicks do
				if GuiService.SelectedObject.Parent == button.Parent then
					VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
					VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
				end
			end
			task.wait()
			GuiService.SelectedObject = nil
		end)
		return x
	end
	return false
end

function Utils.Notify(type, title, message, duration)
	Rey:Notify(type, title, message, duration)
end

-- ============ HAKI SYSTEM ============
local Haki = {}

function Haki.Setup(character)
	if not character or character.Parent == nil then return end
	if character:FindFirstChild("Haki") then return end
	
	local conn
	conn = character.ChildAdded:Connect(function(child)
		if child.Name == "Haki" then
			if conn then
				conn:Disconnect()
				conn = nil
			end
		end
	end)
	
	remote:FireServer("Server", "Misc", "Haki", 1)
	
	task.delay(3, function()
		if conn then
			conn:Disconnect()
			conn = nil
		end
	end)
end

function Haki.Initialize()
	if player.Character then 
		Haki.Setup(player.Character) 
	end
	
	player.CharacterAdded:Connect(function(character)
		task.wait(1)
		Haki.Setup(character)
	end)
end

task.spawn(Haki.Initialize)

-- ============ BOSS SYSTEM ============
local Boss = {}

function Boss.Find()
	local mainFolder = workspace:FindFirstChild("Main")
	if not mainFolder then return nil end
	
	local charsFolder = mainFolder:FindFirstChild("Characters")
	if not charsFolder then return nil end
	
	for _, island in pairs(charsFolder:GetChildren()) do
		local bossFolder = island:FindFirstChild("Boss")
		if bossFolder then
			for _, bossModel in pairs(bossFolder:GetChildren()) do
				if bossModel:IsA("Model") then
					local hrp = bossModel:FindFirstChild("HumanoidRootPart")
					local hum = bossModel:FindFirstChild("Humanoid")
					
					if hrp and hum and hum.Health > 0 then
						return {
							Model = bossModel,
							HRP = hrp,
							Humanoid = hum,
							Island = island.Name,
							Name = bossModel.Name
						}
					end
				end
			end
		end
	end
	
	return nil
end

function Boss.Attack(bossData)
	if not bossData or not bossData.Model or not bossData.Model.Parent then 
		return false 
	end
	
	local char = player.Character
	if not char then return false end
	
	EquipSelectedTools()
	local tool = char:FindFirstChildWhichIsA("Tool")
	if not tool then return false end
	
	local toolType = tool.ToolTip
	if not toolType then return false end
	
	return pcall(function()
		remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
	end)
end

function Boss.RemoveVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and torso:FindFirstChild("BodyVelocity") then
		torso.BodyVelocity:Destroy()
	end
end

function Boss.Toggle(state)
	State.Boss.Active = state
	
	if State.Boss.Connection then
		State.Boss.Connection:Disconnect()
		State.Boss.Connection = nil
	end
	
	Boss.RemoveVelocity()
	
	if state then
		State.Boss.Connection = RunService.Heartbeat:Connect(function()
			if not player.Character then 
				Boss.RemoveVelocity()
				return 
			end
			
			local playerHRP = player.Character:FindFirstChild("HumanoidRootPart")
			if not playerHRP then 
				Boss.RemoveVelocity()
				return 
			end
			
			local boss = Boss.Find()
			
			if boss then
				if boss.Name ~= State.Boss.LastName then
					Utils.Notify("info", "Boss Detected", "Boss Spawned: " .. boss.Name, 5)
					State.Boss.LastName = boss.Name
				end
				
				local torso = player.Character:FindFirstChild("Torso") or player.Character:FindFirstChild("LowerTorso")
				if torso and not torso:FindFirstChild("BodyVelocity") then
					local bv = Instance.new("BodyVelocity", torso)
					bv.Velocity = Vector3.new(0, 0.1, 0)
					bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
				end
				
				if boss.Humanoid and boss.Humanoid.Health > 0 then
					local targetPos = boss.HRP.Position + Vector3.new(0, boss.HRP.Size.Y / 2 + 5, 0)
					playerHRP.CFrame = CFrame.new(targetPos, targetPos - Vector3.new(0, 1, 0))
					Boss.Attack(boss)
				end
			else
				Boss.RemoveVelocity()
				State.Boss.LastName = ""
			end
		end)
	end
end

player.CharacterAdded:Connect(function(char)
	task.wait(1)
	
	if State.Boss.Active then
		Boss.Toggle(false)
		Boss.Toggle(true)
	end
end)

-- ============ GOD MODE SYSTEM ============
local God = {}

function God.MuteObservation(char)
	if not char or char.Parent == nil then return false end
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	local obs = hrp:FindFirstChild("Observation")
	if obs then
		obs.Volume = 0
		return true
	end
	return false
end

function God.StartLoop()
	Utils.StartThread("godMode", function()
		while State.Toggles.GodMode do
			if player.Character and player.Character.Parent ~= nil then
				Utils.FireRemote("Server", "Misc", "Observation", 1)
			end
			task.wait(.1)
		end
	end)
end

function God.SetupObservers()
	for _, plr in pairs(game.Players:GetPlayers()) do
		if plr.Character then 
			God.MuteObservation(plr.Character)
			
			local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				Utils.AddConn("obsChild_" .. plr.Name, hrp.ChildAdded:Connect(function(child)
					if child.Name == "Observation" then
						child.Volume = 0
					elseif child.Name == "Dodge" then
						task.wait(0.1)
						if child.Parent then
							child:Destroy()
						end
					end
				end))
			end
			
			Utils.AddConn("dodgeRemover_" .. plr.Name, plr.Character.ChildAdded:Connect(function(child)
				if child.Name == "Dodge" then
					task.wait(0.1)
					if child.Parent then
						child:Destroy()
					end
				end
			end))
		end
		
		Utils.AddConn("charAddedGod_" .. plr.Name, plr.CharacterAdded:Connect(function(char)
			God.MuteObservation(char)
			
			local hrp = char:WaitForChild("HumanoidRootPart", 5)
			if hrp then
				Utils.AddConn("obsChild_" .. plr.Name, hrp.ChildAdded:Connect(function(child)
					if child.Name == "Observation" then
						child.Volume = 0
					elseif child.Name == "Dodge" then
						task.wait(0.1)
						if child.Parent then
							child:Destroy()
						end
					end
				end))
			end
			
			Utils.AddConn("dodgeRemover_" .. plr.Name, char.ChildAdded:Connect(function(child)
				if child.Name == "Dodge" then
					task.wait(0.1)
					if child.Parent then
						child:Destroy()
					end
				end
			end))
		end))
	end
end

function God.Toggle(state)
	State.Toggles.GodMode = state
	
	if state then
		God.SetupObservers()
		God.StartLoop()
	else
		for _, plr in pairs(game.Players:GetPlayers()) do
			Utils.Cleanup("charAddedGod_" .. plr.Name)
			Utils.Cleanup("obsChild_" .. plr.Name)
			Utils.Cleanup("dodgeRemover_" .. plr.Name)
		end
		Utils.StopThread("godMode")
	end
end

-- ============ FAST ATTACK SYSTEM ============
local Fast = {}

function Fast.GetCharacter()
	local main = workspace:FindFirstChild("Main")
	if not main then return nil end
	
	local chars = main:FindFirstChild("Characters")
	if not chars then return nil end
	
	return chars:FindFirstChild(player.Name)
end

function Fast.GetEquippedTool()
	local char = Fast.GetCharacter()
	if not char then return nil, nil end
	
	local tool = char:FindFirstChildWhichIsA("Tool")
	if not tool then return nil, nil end
	
	return tool, tool.ToolTip
end

function Fast.StartLoop()
	Utils.StartThread("fastAttack", function()
		while State.Toggles.FastAttack do
			local char = Fast.GetCharacter()
			if char and char.Parent ~= nil then
				local tool, toolType = Fast.GetEquippedTool()
				if tool and toolType then
					Utils.FireRemote("Server", toolType, "M1s", tool.Name, 1)
				end
			end
			task.wait()
		end
	end)
end

function Fast.Toggle(state)
	State.Toggles.FastAttack = state
	
	if state then
		Fast.StartLoop()
	else
		Utils.StopThread("fastAttack")
	end
end

-- ============ SELL FISH SYSTEM ============
local SellFish = {}

function SellFish.Setup()
	Utils.Cleanup("autoSellFish")
	Utils.StopThread("autoSellFish")
	
	local NPC = workspace:WaitForChild("Main"):WaitForChild("NPCs"):WaitForChild("Sell Fish")
	local prompt = NPC:FindFirstChildOfClass("ProximityPrompt")
	
	Utils.StartThread("autoSellFish", function()
		while State.Toggles.AutoSellFish do
			task.wait()
			if not NPC or not prompt then return end
			prompt.MaxActivationDistance = 10000
			prompt.RequiresLineOfSight = false
			prompt.HoldDuration = 0
			
			local camera = workspace.CurrentCamera
			if camera and NPC then
				local NPCPosition = NPC:GetPivot().Position
				local lookVector = (NPCPosition - camera.CFrame.Position).Unit
				
				camera.CFrame = CFrame.lookAt(camera.CFrame.Position, camera.CFrame.Position + lookVector)
			end
			
			task.wait()
			VU:CaptureController()
			VU:SetKeyDown("e")
			VU:SetKeyUp("e")
			
			task.wait(3)
		end
	end)
end

function SellFish.Toggle(state)
	State.Toggles.AutoSellFish = state
	
	if state then		
		SellFish.Setup()
		Utils.Cleanup("sellFishCharAdded")
		State.Connections["sellFishCharAdded"] = player.CharacterAdded:Connect(function()
			task.wait(1)
			if State.Toggles.AutoSellFish then
				SellFish.Setup()
			end
		end)
	else
		Utils.Cleanup("autoSellFish")
		Utils.StopThread("autoSellFish")
		Utils.Cleanup("sellFishCharAdded")
		
		local NPC = workspace:FindFirstChild("Main") and workspace.Main:FindFirstChild("NPCs") and workspace.Main.NPCs:FindFirstChild("Sell Fish")
		if NPC then
			local prompt = NPC:FindFirstChildOfClass("ProximityPrompt")
			if prompt then
				prompt.MaxActivationDistance = 10
			end
		end
	end
end

-- ============ FISHING SYSTEM ============
local Fish = {}
Fish.ClickCount = 15

function Fish.Setup()
	Utils.Cleanup("autoFishing")
	Utils.StopThread("autoFishing")
	
	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end
	
	local HUD = playerGui:WaitForChild("HUD", 10)
	if not HUD then return end
	
	Utils.StartThread("autoFishing", function()
		while State.Toggles.AutoFishing do
			Utils.CheckPriority()
			task.wait()
			
			local fishing = HUD:FindFirstChild("Fishing")
			if fishing then
				local button = fishing:FindFirstChild("Button")
				if button then
					if autoFishingV2 then
						Utils.GuiMultiClick(button, Fish.ClickCount)
					else
						Utils.GuiClick(button)
					end
				end
			end
		end
	end)
end

function Fish.Toggle(state)
	State.Toggles.AutoFishing = state
	
	if state then
		Fish.Setup()
		Utils.Cleanup("fishCharAdded")
		State.Connections["fishCharAdded"] = player.CharacterAdded:Connect(function()
			task.wait(1)
			if State.Toggles.AutoFishing then
				Fish.Setup()
			end
		end)
	else
		Utils.Cleanup("autoFishing")
		Utils.StopThread("autoFishing")
		Utils.Cleanup("fishCharAdded")
		task.wait()
		GuiService.SelectedObject = nil
	end
end

function Fish.SetClickCount(click)
	local num = tonumber(click)
	if num and num >= 1 and num <= 30 then
		Fish.ClickCount = math.floor(num)
		
		if State.Toggles.AutoFishing then
			Fish.Setup()
		end
		return true
	end
	return false
end

-- ============ BOSS LIST ============
local function getBossList()
	local list = {}
	local bossUI = player.PlayerGui.Button["Boss Spawn"]
	
	if bossUI then
		local frame = bossUI:FindFirstChild("Frame")
		if frame then
			for _, child in pairs(frame:GetChildren()) do
				if child:IsA("Frame") and child.Name ~= "Frame" then
					local button = child:FindFirstChild("Button")
					if button then
						table.insert(list, child.Name)
					end
				end
			end
		end
	end
	
	return list
end

local bossOptions = getBossList()
local selectedBoss = nil

-- ============ TOOL MANAGER ============
local selectedTools = nil

function GetTools()
	local tools = {}
	local backpack = player:FindFirstChild("Backpack")
	
	if backpack then
		for _, item in pairs(backpack:GetChildren()) do
			if item:IsA("Tool") then
				table.insert(tools, item.Name)
			end
		end
	end
	
	return tools
end

function EquipSelectedTools()
	if not player.Character then return end
	
	local backpack = player:FindFirstChild("Backpack")
	if not backpack then return end
	
	if selectedTools then
		local tool = backpack:FindFirstChild(selectedTools)
		if tool then
			tool.Parent = player.Character
			tool:Activate()
		end
	end
end

-- ============ AUTO FARM BOSS + FISHING (WITH TOOL SUPPORT) ============
local AutoFarmBossFish = {}

AutoFarmBossFish.Mancing = false
function AutoFarmBossFish.CheckFishing()
	local fishing = player:FindFirstChild("Fishing")
	if not fishing and not AutoFarmBossFish.Mancing then
		remote:FireServer("Server", "Misc", "Fishing", true)
		lastState = "fishing"
		AutoFarmBossFish.Mancing = true
	end
	return true
end

function AutoFarmBossFish.CancelFishing()
	remote:FireServer("Server", "Misc", "Fishing", false)
	AutoFarmBossFish.Mancing = false
end

function AutoFarmBossFish.FindBoss()
	local mainFolder = workspace:FindFirstChild("Main")
	if not mainFolder then return nil end
	
	local charsFolder = mainFolder:FindFirstChild("Characters")
	if not charsFolder then return nil end
	
	for _, island in pairs(charsFolder:GetChildren()) do
		local bossFolder = island:FindFirstChild("Boss")
		if bossFolder then
			for _, bossModel in pairs(bossFolder:GetChildren()) do
				if bossModel:IsA("Model") then
					local hrp = bossModel:FindFirstChild("HumanoidRootPart")
					local hum = bossModel:FindFirstChild("Humanoid")
					
					if hrp and hum and hum.Health > 0 then
						return {
							Model = bossModel,
							HRP = hrp,
							Humanoid = hum,
							Island = island.Name,
							Name = bossModel.Name
						}
					end
				end
			end
		end
	end
	
	return nil
end

function AutoFarmBossFish.GetEquippedTool()
	local char = player.Character
	if not char then return nil, nil end
	
	if selectedTools then
		local tool = char:FindFirstChild(selectedTools)
		if tool then
			return tool, tool.ToolTip
		end
	end
	
	local anyTool = char:FindFirstChildWhichIsA("Tool")
	if anyTool then
		return anyTool, anyTool.ToolTip
	end
	
	return nil, nil
end

function AutoFarmBossFish.AttackBoss(bossData)
	if not bossData then return false end
	
	local tool, toolType = AutoFarmBossFish.GetEquippedTool()
	if not tool or not toolType then 
		EquipSelectedTools()
		tool, toolType = AutoFarmBossFish.GetEquippedTool()
		if not tool then return false end
	end
	
	return pcall(function()
		remote:FireServer("Server", toolType, "M1s", tool.Name, 1)
	end)
end

function AutoFarmBossFish.SetupBodyVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and not torso:FindFirstChild("BodyVelocity") then
		local bv = Instance.new("BodyVelocity", torso)
		bv.Velocity = Vector3.new(0, 0.1, 0)
		bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	end
end

function AutoFarmBossFish.RemoveBodyVelocity()
	local char = player.Character
	if not char then return end
	
	local torso = char:FindFirstChild("Torso") or char:FindFirstChild("LowerTorso")
	if torso and torso:FindFirstChild("BodyVelocity") then
		torso.BodyVelocity:Destroy()
	end
end

function AutoFarmBossFish.TeleportToBoss(bossData)
	if not bossData or not player.Character then return end
	
	local playerHRP = player.Character:FindFirstChild("HumanoidRootPart")
	if not playerHRP then return end
	
	local targetPos = bossData.HRP.Position + Vector3.new(0, bossData.HRP.Size.Y / 2 + 5, 0)
	playerHRP.CFrame = CFrame.new(targetPos, targetPos - Vector3.new(0, 1, 0))
end

function AutoFarmBossFish.StartFishing()
	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end
	
	local HUD = playerGui:WaitForChild("HUD", 10)
	if not HUD then return end
	
	local fishing = HUD:FindFirstChild("Fishing")
	if fishing then
		local button = fishing:FindFirstChild("Button")
		if button then
			if autoFishingV2 then
				Utils.GuiMultiClick(button, Fish.ClickCount)
			else
				Utils.GuiClick(button)
			end
		end
	end
end

function AutoFarmBossFish.StartLoop()
	Utils.StartThread("autoFarmBossFish", function()
		lastState = "fishing"
		
		while State.Toggles.AutoFarmBossFish do
			local boss = AutoFarmBossFish.FindBoss()
			
			if boss then
				if lastState ~= "boss" then
					AutoFarmBossFish.CancelFishing()
					lastState = "boss"
					EquipSelectedTools()
				end
				
				AutoFarmBossFish.SetupBodyVelocity()
				AutoFarmBossFish.TeleportToBoss(boss)
				AutoFarmBossFish.AttackBoss(boss)
			else
				if lastState ~= "fishing" then
					AutoFarmBossFish.RemoveBodyVelocity()
				end
				Utils.CheckPriority()
				if AutoFarmBossFish.CheckFishing() then
					AutoFarmBossFish.StartFishing()
				end
			end
			
			task.wait()
		end
		
		AutoFarmBossFish.RemoveBodyVelocity()
		AutoFarmBossFish.CancelFishing()
	end)
end

function AutoFarmBossFish.Toggle(state)
	State.Toggles.AutoFarmBossFish = state
	
	if state then
		EquipSelectedTools()
		AutoFarmBossFish.StartLoop()
		
		Utils.Cleanup("autoFarmCharAdded")
		State.Connections["autoFarmCharAdded"] = player.CharacterAdded:Connect(function()
			task.wait(1)
			if State.Toggles.AutoFarmBossFish then
				AutoFarmBossFish.Toggle(false)
				AutoFarmBossFish.Toggle(true)
			end
		end)
	else
		Utils.StopThread("autoFarmBossFish")
		AutoFarmBossFish.RemoveBodyVelocity()
		AutoFarmBossFish.CancelFishing()
		Utils.Cleanup("autoFarmCharAdded")
	end
end

-- ============ KANEKI'S BLOOD SYSTEM ============
local Kaneki = {}

function Kaneki.Craft()
	local inventory = player.Inventory
	local bossToken = inventory:FindFirstChild("Boss Token")
	local summonOrb = inventory:FindFirstChild("Summon Orb")
	local muzanBlood = inventory:FindFirstChild("Muzan's Blood")
	
	if bossToken and summonOrb and muzanBlood then
		if bossToken.Value >= 25 and summonOrb.Value >= 25 and muzanBlood.Value >= 2 then
			local craftFrame = player.PlayerGui.Button:FindFirstChild("Craft")
			if not craftFrame then return false end
			
			Utils.Priority(function()
				craftFrame.Visible = true
				pcall(function() craftButton = craftFrame.Craft_Frame.Scroll["Kaneki's Blood"].Craft.Button end)
				if craftButton then Utils.GuiClick(craftButton) end
				craftFrame.Visible = false
				return true
			end)
		end
	end
	return false
end

function Kaneki.StartLoop()
	Utils.StartThread("Kaneki", function()
		while State.Toggles.AutoKanekiBlood do
			Kaneki.Craft()
			task.wait()
		end
	end)
end

function Kaneki.Toggle(state)
	State.Toggles.AutoKanekiBlood = state
	
	if state then
		Kaneki.StartLoop()
	else
		Utils.StopThread("Kaneki")
		task.wait()
		GuiService.SelectedObject = nil
	end
end

-- ============ AUTO EXCHANGE SYSTEM ============
local Exchange = {}

Exchange.EXCEPTIONS = {
	["Summon Orb"] = true,
	["RC Cells"] = true
}

function Exchange.GetAmount(text)
	local clean = text:gsub("%[x", ""):gsub("%]", "")
	return tonumber(clean) or 0
end

function Exchange.CheckAndSell()
	local exchange = player.PlayerGui.Button["Chest Exchange"]
	if not exchange then return end
	
	local medalFrame = exchange:FindFirstChild("Medal_Frame")
	if not medalFrame then return end
	
	for _, child in pairs(medalFrame:GetChildren()) do
		if child:IsA("Frame") then
			local name = child.Name
			if Exchange.EXCEPTIONS[name] then
				continue
			end
			
			local amountChild = child:FindFirstChild("Amount") or child:FindFirstChild("Amout")
			local button = child:FindFirstChild("Button")
			
			if amountChild and button then
				local amount = Exchange.GetAmount(amountChild.Text)
				
				if amount > 250 then
					Utils.Priority(function()
						exchange.Visible = true
						Utils.GuiClick(button)
						exchange.Visible = false
					end)
				end
			end
		end
	end
end

function Exchange.StartLoop()
	Utils.StartThread("exchange", function()
		while State.Toggles.AutoExchange do
			Exchange.CheckAndSell()
			task.wait(5)
		end
	end)
end

function Exchange.Toggle(state)
	State.Toggles.AutoExchange = state
	
	if state then
		Exchange.StartLoop()
	else
		Utils.StopThread("exchange")
		task.wait()
		GuiService.SelectedObject = nil
	end
end

-- ============ AUTO SPAWN BOSS SYSTEM ============
local AutoSpawn = {}

function AutoSpawn.Toggle(state)
	AutoSpawn.Running = state
	if state then
		local bossSpawn = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"]
		if bossSpawn then
			bossSpawn.BackgroundTransparency = 1
			local spawnFrame = bossSpawn.Spawn
			if spawnFrame then
				local button = spawnFrame.Button
				if button then
					for _, descendant in ipairs(bossSpawn:GetDescendants()) do
						if descendant:IsA("GuiObject") then
							if descendant == button or descendant == spawnFrame or descendant == bossSpawn then
								descendant.Visible = true
								if descendant:IsA("Frame") then
									descendant.BackgroundTransparency = 1
								end
							else
								descendant.Visible = false
							end
						end
					end
					button.Visible = true
					spawnFrame.Visible = true
					bossSpawn.Visible = true
				end
			end
		end
		
		task.spawn(function()
			while AutoSpawn.Running do Utils.CheckPriority() task.wait(0.8)
				pcall(function()
					local inventory = game:GetService("Players").LocalPlayer.Inventory
					local summonOrb = inventory:FindFirstChild("Summon Orb")
					
					if summonOrb then
						if State.Toggles.AutoFarmBossFish and summonOrb.Value < 750 then
							return
						end
					end
					
					local obj = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"].Spawn
					local button = obj:FindFirstChild("Button")
					if button then
						Utils.GuiClick(button)
					end
				end)
			end
		end)
	else
		AutoSpawn.Running = false
		
		local bossSpawn = game:GetService("Players").LocalPlayer.PlayerGui.Button["Boss Spawn"]
		if bossSpawn then
			bossSpawn.BackgroundTransparency = 0
			for _, descendant in ipairs(bossSpawn:GetDescendants()) do
				if descendant:IsA("GuiObject") then
					descendant.Visible = true
					if descendant:IsA("Frame") then
						descendant.BackgroundTransparency = 0
					end
				end
			end
			bossSpawn.Visible = false
			task.wait()
			GuiService.SelectedObject = nil
		end
	end
end
-- ============ HOGYOKU FRAGMENT EXCHANGE SYSTEM ============
local Hogyoku = {}

function Hogyoku.GetShardCount()
	local success, count = pcall(function()
		local inventory = player:WaitForChild("Inventory")
		local rerollShard = inventory:WaitForChild("Reroll Shard")
		return rerollShard.Value
	end)
	
	return success and count or 0
end

function Hogyoku.CheckAndExchange()
	local shardCount = Hogyoku.GetShardCount()
	
	if shardCount < 255 then
		return false
	end
	
	local exchangeButton
	local success = pcall(function()
		local playerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
		local buttonFolder = playerGui:WaitForChild("Button")
		local exchangeFrame = buttonFolder:WaitForChild("Exchange_Frame")
		local materialFrame = exchangeFrame:WaitForChild("Material_Frame")
		local rerollFrame = materialFrame:WaitForChild("Reroll Shard")
		exchangeButton = rerollFrame:WaitForChild("Button")
	end)
	
	if not success or not exchangeButton then
		return false
	end
	Utils.Priority(function()
		Utils.GuiClick(exchangeButton)
	end)
end

function Hogyoku.StartLoop()
	Utils.StartThread("hogyoku_exchange", function()
		while State.Toggles.AutoHogyoku do
			Hogyoku.CheckAndExchange()
			task.wait()
		end
	end)
end

function Hogyoku.Toggle(state)
	State.Toggles.AutoHogyoku = state
	
	if state then
		Hogyoku.StartLoop()
	else
		Utils.StopThread("hogyoku_exchange")
		task.wait()
		GuiService.SelectedObject = nil
	end
end
-- ============ Disable Mobile Check Skills ============
function MobileCheckSkill()
local mobileUI = player.PlayerGui:FindFirstChild("Mobile")
	if mobileUI then
		local check = mobileUI:FindFirstChild("Check")
		if check then
			check.Disabled = true
		end
	end
end
-- ============ AUTO TITLE SYSTEM ============
local AutoTitle = {}

function AutoTitle.GetTitles()
	local titles = {}
	local playerGui = player.PlayerGui
	
	if playerGui and playerGui.Button then
		local titleFrame = playerGui.Button.Title_Frame
		if titleFrame then
			local innerFrame = titleFrame.Frame
			if innerFrame then
				for _, child in pairs(innerFrame:GetChildren()) do
					if child:IsA("Frame") and child.Equip and child.Equip.Button then
						table.insert(titles, child.Name)
					end
				end
			end
		end
	end
	
	table.sort(titles)
	return titles
end

function AutoTitle.SelectTitle(titleName)
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return false end
	
	local titleFrame = playerGui.Button.Title_Frame
	if not titleFrame then return false end
	
	local targetButton = titleFrame.Frame[titleName].Equip.Button
	if not targetButton then return false end
	
	local success = pcall(function()
		Utils.Priority(function()
			titleFrame.Visible = true
			Utils.GuiClick(targetButton)
			titleFrame.Visible = false
		end)
	end)
	
	if not success then
		titleFrame.Visible = false
	end
	
	return success
end

function AutoTitle.SelectTitleCallback(selectedTitle)
	Utils.Priority(function()
		local success = AutoTitle.SelectTitle(selectedTitle)
		if success then
			ReyUILib:Notify("success", "Title Changed", "Changed to: " .. selectedTitle, 3)
		else
			ReyUILib:Notify("error", "Title Change Failed", "Failed to select: " .. selectedTitle, 3)
		end
	end)
end
-- ============ Select + Force Menu ============
local forceMenuActive = false
local selectedMenu = nil
local prevMenu = nil

local function getMenuOptions()
	local options = {}
	local playerGui = player.PlayerGui
	
	if playerGui and playerGui.Button then
		for _, child in pairs(playerGui.Button:GetChildren()) do
			if child:IsA("Frame") then
				local name = child.Name
				name = name:gsub("_Frame", "")
				table.insert(options, name)
			end
		end
	end
	
	return options
end

local function getOriginalName(displayName)
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return displayName end
	
	local frame = playerGui.Button:FindFirstChild(displayName)
	if frame then return displayName end
	
	frame = playerGui.Button:FindFirstChild(displayName .. "_Frame")
	if frame then return displayName .. "_Frame" end
	
	return displayName
end

local function hideAllMenus()
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return end
	
	for _, child in pairs(playerGui.Button:GetChildren()) do
		if child:IsA("Frame") then
			child.Visible = false
		end
	end
end

local function showSelectedMenu()
	if not forceMenuActive or not selectedMenu then return end
	
	local playerGui = player.PlayerGui
	if not playerGui or not playerGui.Button then return end
	
	local originalName = getOriginalName(selectedMenu)
	local menuFrame = playerGui.Button:FindFirstChild(originalName)
	if menuFrame then
		menuFrame.Visible = true
	end
end

local function toggleForceMenu(state)
	forceMenuActive = state
	
	if state then
		if selectedMenu then
			showSelectedMenu()
		end
	else
		hideAllMenus()
		prevMenu = nil
	end
end

local menuOptions = getMenuOptions()

function SelectForceMenu(selection)
	if prevMenu then
		local originalPrev = getOriginalName(prevMenu)
		local prevFrame = player.PlayerGui.Button:FindFirstChild(originalPrev)
		if prevFrame then
			prevFrame.Visible = false
		end
	end
	
	selectedMenu = selection
	prevMenu = selection
	
	if forceMenuActive then
		showSelectedMenu()
	end
end

-- ============ Level Up Busoshoku Haki ============
function LevelUpHaki()
	for i = 1, 500 do
		if player.Character and player.Character.Parent ~= nil then
			Utils.FireRemote("Server", "Misc", "Haki", 1)
			Utils.FireRemote("Server", "Misc", "Haki", 2)
		else
			break
		end
	end
end
-- ============ Select Boss Auto Spawn ============
function SelectBossAutoSpawn(selectedBoss)
	local bossUI = player.PlayerGui.Button["Boss Spawn"]
	if bossUI then
		bossUI.Visible = true
		local frame = bossUI:FindFirstChild("Frame")
		if frame and selectedBoss then
			local bossFrame = frame:FindFirstChild(selectedBoss)
			if bossFrame then
				local button = bossFrame:FindFirstChild("Button")
				if button then
					Utils.GuiClick(button)
					bossUI.Visible = false
				end
			end
		end
	end
end
-- ============ UI COMPONENTS ============
Rey:CreateDropdown(Exclusive, "Pilih Tools", GetTools, function(value)
	selectedTools = value
end, true, {"tools", "weapon", "tool"})

Rey:CreateToggle(Exclusive, "Auto Boss + Fishing", "Auto farm boss + fishing", AutoFarmBossFish.Toggle, {"autofarm", "farmbossfish", "afbf"})

Rey:CreateToggle(Exclusive, "Auto Bosses", "Auto farm bosses (bug)", Boss.Toggle, {"autoboss", "bossfarm", "ab"})

Rey:CreateToggle(Exclusive, "God Mode", "Required: Observation Haki", God.Toggle, {"god", "godmode", "gm"})

Rey:CreateToggle(Exclusive, "Fast Attack M1", "Required: Tool yang di-equip", Fast.Toggle, {"fastattack", "fastm1", "m1", "fast"})

Rey:CreateToggle(Exclusive, "Auto Sell Fish", "kinda bug, gabisa fire pp jadi method ini(jelek euy)", SellFish.Toggle, {"autosell", "sellfish", "as"})
Rey:CreateToggle(Exclusive, "Auto Fishing", "Auto fishing system baru", Fish.Toggle, {"autofish", "autofishing", "af"})
Rey:CreateToggle(Exclusive, "Auto Fishing V2", "Auto fishing MultiClick (OP mampus)", function(state)
	autoFishingV2 = state
	if State.Toggles.AutoFishing then
		Fish.Setup()
	end
end, {"autofishv2", "fishingv2", "afv2"})
Rey:CreateSlider(Exclusive, "Fish MultiClick", 1, 30, 15, function(value)
	local success = Fish.SetClickCount(value)
	if success then
		Rey:Notify("info", "Click Count", string.format("Set to %d Clicks per Fishing", value), 2)
	end
end, {"clickcount", "multiclick", "clicks", "cc"})
Rey:CreateButton(Exclusive, "Start Fishing", "Mancing dimanapun", "Start", function()
	local fishing = player:FindFirstChild("Fishing")
	if not fishing then
		remote:FireServer("Server", "Misc", "Fishing", true)
	end
end, {"startfishing", "sf", "fish", "fishing"})

Rey:CreateDropdown(Exclusive, "Pilih Boss", bossOptions, SelectBossAutoSpawn, false, {"boss", "selectboss", "sb"})
Rey:CreateToggle(Exclusive, "Auto Spawn Boss", "Select Boss nya dulu", AutoSpawn.Toggle, {"autospawn", "spawnboss", "asb"})
Rey:CreateNote(Exclusive, "-\n-\n-\n-\n-")

-- ============ EXCLUSIVE 2 ============
Rey:CreateToggle(Exclusive2, "Disable Announced Pop-up", "-", function(state)
	player.Setting["Announce Pop-up"].Value = not state
end, {"disablepopup", "nopopup", "dp"})

Rey:CreateToggle(Exclusive2, "Auto Exchange Chest", "Auto exchange chest jika Items >250", Exchange.Toggle, {"autochest", "exchangechest", "ac"})

Rey:CreateToggle(Exclusive2, "Auto Buy Kaneki's Blood", "Auto buy jika bahan cukup", Kaneki.Toggle, {"kaneki", "buykaneki", "kb"})

Rey:CreateToggle(Exclusive2, "Auto Exchange Hogyoku Fragment", "Auto exchange kalo reroll >250", Hogyoku.Toggle, {"hogyoku", "exchangehogyoku", "eh"})

Rey:CreateNote(Exclusive2, "⚠️ Warning: Don't activate features unnecessarily to avoid lag")

Rey:CreateButton(Exclusive2, "Farm Level Busoshoku Haki", "Level up gradually to avoid lag", "Level Up", LevelUpHaki)

Rey:CreateNote(Exclusive2, "⚠️ Warning: Semua Skill bakal di deactivate paksa\nBisa Fix Yuta Lag Issue, respawn klo mau matiin fitur")

Rey:CreateButton(Exclusive2, "Disable Mobile Check Skill", "Baca note diatas", "DISABLE", MobileCheckSkill)

Rey:CreateDropdown(Exclusive2, "Change Title", AutoTitle.GetTitles, AutoTitle.SelectTitleCallback, false, "title")

Rey:CreateDropdown(Exclusive2, "Select Menu", menuOptions, SelectForceMenu, true, {"menu", "selectmenu", "sm"})

Rey:CreateToggle(Exclusive2, "Force Menu", "Force open selected menu", toggleForceMenu, {"forcemenu", "openmenu", "fm"})
Rey:CreateNote(Exclusive2, "-\n-\n-\n-\n-")

-- ============ CLEANUP ============
local Cleanup = {}

function Cleanup.All()
	for key, conn in pairs(State.Connections) do
		Utils.Disconnect(conn)
	end
	table.clear(State.Connections)
	
	for key, thread in pairs(State.Threads) do
		if thread then
			task.cancel(thread)
		end
	end
	table.clear(State.Threads)
	
	for key, _ in pairs(State.Toggles) do
		State.Toggles[key] = false
	end
	
	State.Boss.Active = false
	State.Boss.LastName = ""
	if State.Boss.Connection then
		State.Boss.Connection:Disconnect()
		State.Boss.Connection = nil
	end
	
	Boss.RemoveVelocity()
	AutoFarmBossFish.RemoveBodyVelocity()
	AutoFarmBossFish.CancelFishing()
	task.wait()
	GuiService.SelectedObject = nil
end

local removeConn
removeConn = Players.PlayerRemoving:Connect(function(leavingPlayer)
	if leavingPlayer == player then
		Utils.Disconnect(removeConn)
		Cleanup.All()
	end
end)

player.CharacterAdded:Connect(function()
	if State.Toggles.GodMode then
		God.SetupObservers()
	end
	
	if State.Boss.Active then
		Boss.Toggle(false)
		Boss.Toggle(true)
	end
end)

game:GetService("CoreGui").DescendantRemoving:Connect(function(desc)
	if desc == UI then
		Cleanup.All()
	end
end)
-- ============ FINAL ============
Utils.Notify("success", "Rogue Piece", "Script Loaded Successfully!", 5)
